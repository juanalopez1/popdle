<dialog #tutorial class="relative mx-auto w-full max-w-lg space-y-6 bg-black p-8 text-center shadow-2xl ring-1 ring-gray-900/10 transition-all transform scale-95 sm:scale-100 opacity-0 hover:opacity-100 focus:outline-none z-20 border-8 border-transparent bg-clip-padding" style="border-image: linear-gradient(to right, #7e22ce, #d10082 30%, #f97316) 1;">
    <div class="space-y-4">
        <p class="text-2xl font-extrabold text-gray-200">
            {{ this.dictT().title }}
        </p>
    </div>

    <div class="flex flex-col items-start text-lg text-gray-100 space-y-3 text-left">
        <p class="font-bold text-gray-50">{{ this.dictT().objetiveTitle }}</p>
        <p>{{ this.dictT().objetiveSong }}</p>
    </div>
    
    <div class="flex flex-col items-start text-lg text-gray-100 space-y-3 text-left">
        <p class="font-bold text-gray-50">{{ this.dictT().howToPlayTitle }}</p>
        <p>{{ this.dictT().howToPlaySong }}</p>
    </div>

    <div class="flex flex-col items-start text-lg text-gray-100 space-y-3 text-left">
        <p class="font-bold text-gray-50">{{ this.dictT().feedback }}</p>
        <p>{{ this.dictT().feedbackDescription }}</p>
        <div class="flex flex-col gap-2 ">
            <p>{{ this.dictT().correctAlbum }}</p>
            <hlm-icon name="lucideCheck" class='bg-green-500 rounded-full size-5'></hlm-icon>
        </div>
        <div class="flex items-center space-x-2">
            <p>{{ this.dictT().incorrectAlbum }}</p>
            <hlm-icon name="lucideX" class='bg-red-500 rounded-full size-5'></hlm-icon>
        </div>
        <p>{{ this.dictT().snippet }}</p>
    </div>
    
    <button
        class="flex-1 rounded-lg bg-gray-300 px-6 py-3 font-semibold text-gray-800 transition hover:bg-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50"
        (click)="this.closeDialog()"
    >
        {{ this.dictT().start }}
    </button>
</dialog>

@if(this.blurOn){
    <div #blur class="fixed inset-0 bg-gray-800 bg-opacity-50 backdrop-blur-sm z-10"></div>
}
@if (this.gameInfo()) {
<header
    class="my-5 h-48 w-full overflow-hidden rounded-2xl border border-muted bg-cover bg-center"
    style="background-image: url({{ this.gameInfo()!.album!.images?.[0]?.url }});"
>
    <div
        class="flex h-full w-full flex-row justify-between gap-6 p-6 backdrop-blur backdrop-brightness-50"
    >
        <a
            [href]="this.gameInfo()?.artists?.[0]?.external_urls?.spotify"
            class="aspect-square h-full w-fit"
        >
            <img
                [src]="this.gameInfo()?.artists?.[0]?.images?.[0]?.url"
                alt=""
                class="aspect-square h-full rounded-xl shadow transition-transform hover:scale-105"
            />
        </a>
        <div class="flex w-full flex-col justify-center gap-4">
            <div
                [ngClass]="{
                    'w-full rounded bg-muted/80 text-5xl shadow grayscale backdrop-blur': true,
                    'bg-opacity-0': this.hasEnded(),
                }"
            >
                @if (!this.hasEnded()){ <span class="invisible"> Shh </span>}
                @else {
                <span class="text-5xl"
                    >{{ this.gameInfo()?.correctTrack?.name }}</span
                >
                }
            </div>
            <span class="text-3xl drop-shadow"
                >{{ this.dict().by(this.gameInfo()?.artists ?? []) }}</span
            >
        </div>
    </div>
</header>
<section class="my-5 mb-20 grid grid-cols-1 gap-4 px-6">
    @for (attempt of this.computedAttempts(); track $index) {
    <article
        class="w-full overflow-hidden rounded-2xl border border-muted bg-cover bg-center"
        style="background-image: url({{ attempt.guessedTrack.album.images[0].url }});"
    >
        <div
            class="flex h-full w-full flex-row justify-between gap-6 p-6 backdrop-blur backdrop-brightness-50"
        >
            <div class="flex h-full shrink-0 items-center">
                <div class="relative">
                    <a
                        class="aspect-square h-full w-fit"
                        [href]="attempt.guessedTrack.album.external_urls.spotify"
                    >
                        <img
                            [src]="attempt.guessedTrack.album.images[0].url"
                            alt=""
                            class="my-auto aspect-square h-32 rounded-xl shadow transition-transform hover:scale-105"
                        />
                    </a>
                    <div
                        class="absolute bottom-2 right-2 z-10 flex h-5 w-5 items-center justify-center rounded-full"
                        [ngClass]="{
                            'bg-green-500': attempt.isCorrectAlbum,
                            'bg-red-500': !attempt.isCorrectAlbum,
                        }"
                    >
                        @if (attempt.isCorrectAlbum) {
                        <hlm-icon name="lucideCheck" size="sm"></hlm-icon>
                        } @else {

                        <hlm-icon name="lucideX" size="sm"></hlm-icon>
                        }
                    </div>
                </div>
            </div>
            <a
                class="group flex w-full flex-col justify-center gap-4"
                [href]="attempt.guessedTrack.external_urls.spotify"
            >
                <app-wordle-text
                    class="w-fit transition-all group-hover:scale-105"
                    [text]="attempt.guessedTrackNameHint"
                    [isPending]="false"
                ></app-wordle-text>
                <span class="text-3xl drop-shadow">
                    {{ this.dict().from(attempt.guessedTrack.album.name)
                    }}</span
                >
            </a>
        </div>
    </article>
    @if ($index === 4 && !attempt.isCorrectTrack) {
    <article
        class="w-full rounded-2xl border border-muted bg-accent p-6 text-accent-foreground"
    >
        <h2>{{ this.dict().snippet }}</h2>
        <p class="text-2xl">
            {{ this.gameInfo()?.snippet ?? "We could not find lyrics for this
            track." }}
        </p>
    </article>
    } } @if (!hasEnded()) {
    <article
        (click)="this.focusInput()"
        class="relative w-full overflow-hidden rounded-2xl border border-muted focus-within:border-fuchsia-500"
    >
        <div
            class="flex h-full w-full flex-row justify-between gap-6 p-6 backdrop-blur backdrop-brightness-50"
        >
            <div class="flex w-full flex-col justify-center gap-4">
                <app-wordle-text
                    [text]="this.shownValue()"
                    [isPending]="true"
                    [selection]="this.selection"
                ></app-wordle-text>
            </div>
        </div>
        <input
            #hiddenInput
            (input)="this.onInput()"
            (keydown)="this.keyDown($event)"
            (keyup)="this.onInput()"
            (click)="this.onInput()"
            class="absolute h-0 opacity-0"
            [(ngModel)]="this.value"
        />
    </article>
    } @if (this.hasEnded()) {
    <div class="mt-5 flex flex-col items-center gap-5">
        @if (this.hasWon()) {
        <h1
            class="mx-auto bg-gradient-to-r from-purple-500 via-fuchsia-500 via-[30%] to-orange-500 to-[calc(100%+15rem)] bg-clip-text text-6xl font-extrabold text-transparent"
        >
            {{ this.dict().wonTitle }}
        </h1>
        } @if (this.hasLost()) {
        <h1 class="mx-auto text-6xl font-extrabold">
            {{ this.dict().lostTitle }}
        </h1>
        }
        <iframe
            class="rounded-2xl"
            [src]="this.embedSrc() ?? '' | safe"
            width="100%"
            height="352"
            frameborder="0"
            allowfullscreen=""
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy"
        ></iframe>
        <div class="mt-2 flex w-fit justify-between gap-20">
            <a
                [href]="this.router.createLink('/app/leaderboards')"
                hlmBtn
                variant="ghost"
                class="text-xl font-bold"
                >{{ this.dict().seeFriends }}</a
            >
            <a
                [href]="this.router.createLink('/app/game')"
                hlmBtn
                variant="ghost"
                class="text-xl font-bold"
                >{{ this.dict().playAgain }}</a
            >
        </div>
    </div>
    }
</section>
}

<hlm-dialog #pickTrackDialog>
    <hlm-dialog-content
        *brnDialogContent="let ctx"
        class="w-fit max-w-screen-sm"
    >
        <h1 class="text-md font-extrabold">Which track did you mean?</h1>
        @if (this.trackOptions() === undefined) {
        <h1>Loading!</h1>
        } @else {
        <hlm-scroll-area
            track="vertical"
            class="h-96 w-[36rem] overflow-hidden"
        >
            @for (track of this.trackOptions()?.items; track track.id) {
            <button
                (click)="this.submitAttempt(track)"
                type="button"
                class="m-2 flex w-[35rem] items-center gap-2 overflow-hidden text-ellipsis rounded p-2 hover:bg-muted"
            >
                <img
                    [src]="track.album.images[0].url"
                    class="h-20 w-20 rounded"
                    alt=""
                />
                <div
                    class="flex w-full flex-col items-start overflow-hidden text-ellipsis text-nowrap"
                >
                    <span class="block text-ellipsis"> {{ track.name }} </span>
                    <span class="block w-full text-ellipsis text-left text-sm">
                        By {{ this.dict().stringifyArtists(track.artists) }}
                    </span>
                    <span class="block w-full text-ellipsis text-left text-sm">
                        From {{ track.album.name }}
                    </span>
                </div>
            </button>
            }
        </hlm-scroll-area>
        }
    </hlm-dialog-content>
</hlm-dialog>
